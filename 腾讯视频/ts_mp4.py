# -- coding: utf-8 --
# @Author: 胡H
# @File: ts_mp4.py
# @Created: 2025/4/2 16:21
# @LastModified: 
# Copyright (c) 2025 by 胡H, All Rights Reserved.
# @desc:  将可用ts列表转换成mp4
import re
import subprocess


def FFmpeg_merg(ts_urls):
    list_file = "ts_list.txt"
    with open(list_file, 'w') as f:
        for url in ts_urls:
            f.write(f"file '{url}'\n")  # 注意格式：每行以 'file ' 开头

    # 2. 使用 FFmpeg 合并
    output_file = "merged_video.mp4"
    command = [
        'ffmpeg',
        '-f', 'concat',
        '-safe', '0',  # 禁用安全检查（允许远程文件）
        '-protocol_whitelist', 'file,http,https,tcp,tls',  # 允许所有协议
        '-i', list_file,  # 输入列表文件
        '-c', 'copy',  # 直接复制流（不重新编码）
        '-bsf:a', 'aac_adtstoasc',  # 修复音频格式（AAC流必须）
        output_file
    ]

    try:
        subprocess.run(command, check=True)
        print("合并成功！")
    except subprocess.CalledProcessError as e:
        print(f"合并失败: {e}")


def ts_convert(m3u8_content, uel_header_v2):
    ts_urls = re.findall(r'(.+?\.ts\?.+?)(?=\s|$)', m3u8_content)
    # uel_header  = 'https://apd-vlive.apdcdn.tc.qq.com/defaultts.tc.qq.com/B_fXrb0otmtGHxqhZ5HYDTdpaVKpLEyUfm2-beHHamm3jvUy4IiEiqodQ2C1GN8LOpGvrzU_xZYb2n3BCGv-LMrolzZi2SwYLcmpNkUm_bn60FyzzhwDvF1V5YyaAUUw81Sg519NWDEvBWWQGpQ5Blpw/svp_50112/sWhJY3dcI8KVQMOuwc0MBiPg3IMRc_lC-sY3Q2gmpyM-IIAK_9drjd7Ahi_tRT3EmBG9uigtmPGJkdVXUNqTC7Zl1yNM49OxKMTr7XKiYOks3og5kn4CA7T_HS2lan14R_0xaEQOPlhZlqNc1iZY8ExoHtGWlP2fy_w3Tkw5ElEI-inGf3TxQYZtCXipFgTYoWlZcpkrciIUQKbRfRfaIYCZR1TZ1j82jCOJ4DH2P5c/'
    ts_list = [uel_header_v2 + url.strip() for url in ts_urls]
    print(ts_list)
    print("提取的 .ts 文件数量:", len(ts_list))
    print('正在下载mp4', '=' * 4)
    FFmpeg_merg(ts_list)  # ts列表生成mp4

if __name__ == '__main__':
    m3u8_content ="""
    #EXTM3U
#EXT-X-VERSION:3
#EXT-X-MEDIA-SEQUENCE:0
#EXT-X-TARGETDURATION:16
#EXT-X-PLAYLIST-TYPE:VOD
#EXTINF:11.302,
https://hls.one/TX_6235363343565a5644514942414678564177525a41464d425656594743465656436746534467306652514e5355515a5344417441526c635856554d4155516b46464163
#EXTINF:11.929,
https://hls.one/TX_61346463435645474177634855466f485631515041464e575641494641674e5456314d44567741655341465442775a534331684f513146485568465555675942464151
#EXTINF:11.553,
https://hls.one/TX_64326231427741474267594742676749416c554741414145423141434151425441315263554164485141414944565663576c684c516c41524178344241314e5846674d
#EXTINF:11.303,
https://hls.one/TX_64326231427741474267594742676749416c425456464d42565142585851494142774266566c5a485141414944565663576c684c516c41524168344241314e5846674d
#EXTINF:11.512,
https://hls.one/TX_3839346443414657565649435531674241676b45584163455641514656565251566c414455516b575151685542464a5457776759466c5245565263424156414e45674d
#EXTINF:11.928,
https://hls.one/TX_306331334277594d44464941416730435551565341466f4656514a5956514e574256414244315a48535152545551426358464a42466c59564152525341676342524141
#EXTINF:11.387,
https://hls.one/TX_6264666355464e574267674243417746433146544241594b44465a5457675a5443774e64566741544567554342514d4c4351684c5446636641784d4956464a53467749
#EXTINF:11.219,
https://hls.one/TX_63303363425646524241565743416b4641315654425642554241554741564144555646565646564852774548424164654377394a5151416642784d4141566344465649
#EXTINF:10.469,
https://hls.one/TX_396530364177594655415657415138494251514855566457566c4d4642414a535641674f4141684445774a5342314e5958467364515141574468344742515251516c41
#EXTINF:11.220,
https://hls.one/TX_343236325677594642674541557777475646454341414d444141594156313444445163474146455251564e544277414d5846744c52565a45444242585577525245564d
#EXTINF:11.887,
https://hls.one/TX_343236325677594642674541557777475641414e55464a554241454641566b4f444174584146555251564e544277414d5846744c52565a4542415a415567565541305148
#EXTINF:10.010,
https://hls.one/TX_34376163414164515651525642466f47564663445631515042776457556752524151494c58414243456c4d4856775a625851345951414d54556764414241454142424654
#EXTINF:11.344,
https://hls.one/TX_3834363541464d4d416c55445567384a4156634142415a525677425156465a58555151484131416552774a56556c566243564a50455656464277735641414d4656304944
#EXTINF:11.303,
https://hls.one/TX_303766305656494744515144435173414367594357773153446c4947563139664331634742314954515659455667384f434668415146556541774d65564652534145554a
#EXTINF:11.679,
https://hls.one/TX_32616434557751475656454b55777345563159414231465255776b4556674d42556c4a564356455851464a5656675949586c675946567845417742445631594642425253
#EXTINF:11.845,
https://hls.one/TX_32616434557751475656454b55777345563155464231494656677857416c4943446756574346455851464a5656675949586c675946567845417746445631594642425253
#EXTINF:11.928,
https://hls.one/TX_363762335577425355416c52564168525551494141563555426c4942416c45424367554241774157466c554442465149576777645451644441466446416c454744455544
#EXTINF:11.554,
https://hls.one/TX_65623964556741474151454b565174555677525856464d4842774d4857514e5841515a5542314d65465163444177384a576c684d5256784341314e445531465456524256
#EXTINF:11.928,
https://hls.one/TX_3266336355776457444655464277674556465943427759504167594342314e5656674a5144776c4445514544555649495851684245564d51414178414151494156684656
#EXTINF:11.929,
https://hls.one/TX_33656265567745484441494156317457414642565641356255314655423156594351414356776355535142565651554d57316c42526c5a415531385542414253416b5258
#EXTINF:11.887,
https://hls.one/TX_326665625546494d5667414555466744426749464131745843464a5955674e5442514a5643515966456c454a4151414c4346496252464a4855774d53556c465156304149
#EXTINF:11.928,
https://hls.one/TX_37363033427735534451525255317056426c554e556c45494156525555314a5444674d4744514152516c5a574241356356417841514164455556515341416c5842683846
#EXTINF:11.845,
https://hls.one/TX_37363033427735534451525255317056426c51505577734255674e5541416c5258565655566c5152516c5a574241356356417841514164455556635341416c5842683846
#EXTINF:10.845,
https://hls.one/TX_35656333427751464251594b4267344556314a6556516f45415664584141645356315258554652464667525455516463586c7449516c7752425164444256594844525147
#EXTINF:11.469,
https://hls.one/TX_38376562556c4d4741315a5255413952415141475651454956314e525541395142314941416c6365515146564167414a4356684f45676448424655565546514844425a53
#EXTINF:11.929,
https://hls.one/TX_3933323241776457566c4e58563168564177304341466863563156574167425156414a5355516b57524152544267645958516762467746415531415843464d4856554a58
#EXTINF:11.929,
https://hls.one/TX_303033395631594242776453434177455677315141316f4a4251494855774a5642774e5642566f5446416b424441634d4446394b5177516642774a444341594844425947
#EXTINF:11.928,
https://hls.one/TX_3030333956315942427764534341774556773551553134474431414758515a58425163484446345446416b424441634d4446394b5177516642774e444341594844425947
#EXTINF:11.428,
https://hls.one/TX_626431384231454344514a5341776c57557752535641414742564d4241514a53426745465641644653464542416746634331784152675155416c35484231494555455145
#EXTINF:10.970,
https://hls.one/TX_313339654351425841414943554668564251554d4277594242314657554173435631774155775a4546414e524177465357676c4e526c5248553177525651554142785651
#EXTINF:11.928,
https://hls.one/TX_34336565426c5141444146565541425341675a5857774150435145454277634156774546426749574667514142564e64446c354252514e48436c4957426c454a4278454a
#EXTINF:11.595,
https://hls.one/TX_393932375631565256674a5143516f45417770525541414156414a514151414c564141434331424851414e5541774d4d4477386252675965414155584356494156304147
#EXTINF:11.303,
https://hls.one/TX_36656531426c594241774144567777474277634456465a645851414e5631634442674a545631635252516b43565142644446394f52465641426751545677465355683955
#EXTINF:11.553,
https://hls.one/TX_6562383842775145426c514456776b4a4151745542314e565677304241776346414639615667424451514d4a56675263586c704c4546564141776f5643564e56556b4948
#EXTINF:11.929,
https://hls.one/TX_6562383842775145426c514456776b4a41566f46415655474156785556464541414141504177464451514d4a56675263586c704c454656414177305643564e56556b4948
#EXTINF:11.053,
https://hls.one/TX_3137636256515a535551454342317347426c45474146425441514a56557756535577315241673454514142524256514f584177635256515155514d534177634341684141
#EXTINF:11.803,
https://hls.one/TX_3130633256565a5841776b415641344a4131734b4141674e41516f45417745434346565344464566526c49484231414f44416c4f54565a44424138584341685444423443
#EXTINF:11.804,
https://hls.one/TX_353463314267554155564947435173415551465342674541556c594d56674145426c554844565241516c4d4155674e6458313463466c4165415164464146525644525254
#EXTINF:11.928,
https://hls.one/TX_636437654156525141675a5341317344564141424341785342675542433134475646734144415a464577554842314e6144673550516751555551744143416b4244455144
#EXTINF:11.261,
https://hls.one/TX_636437654156525141675a534131734456417866425678524241315842416f4d41675947567752464577554842314e6144673550516751555551704143416b4244455144
#EXTINF:11.929,
https://hls.one/TX_6132363242314a5342565144416c384241464e5155676b484256395142514a5a42774a514351495345514254444146634341784945465556556745554267465442525541
#EXTINF:10.677,
https://hls.one/TX_3030333542415a535567525143513849425652624141645443674a6256464149567749415656635153516c5555564266584177665141596541676b5241564d4456685144
#EXTINF:10.135,
https://hls.one/TX_3337653842464547445149464356674456775946426c5145424674655651304242564543413145585131514756674e6643316841526c4d655651464441414a5641305141
#EXTINF:11.095,
https://hls.one/TX_6339383841565a534151465642516f474167494741673953414164534231384841774a555667515153565948567756614441784d52514d53427755574151525641685944
#EXTINF:11.928,
https://hls.one/TX_31626138567755425677494343516852554146554167454842314a57564130504156465942515155457763434451414d58313861526c5165425656454177634141554947
#EXTINF:11.137,
https://hls.one/TX_3162613856775542567749434351685255414d45415642584246565742317465446c646342566355457763434451414d58313861526c5165425652454177634141554947
#EXTINF:11.928,
https://hls.one/TX_646463394356465756775943564670554146554155676c5741774542424655424141316357314965514164524267645343776761516c52445631495556416b4744424a58
#EXTINF:11.929,
https://hls.one/TX_6563663641464d45415152564241315543315947556739515551454355516f4842774d4855514558456c4542554152624356704d51414d5441464d6642514a5144424942
#EXTINF:11.928,
https://hls.one/TX_323939344177465755415142564145494251645542464a58555163415567554a56417051587741564577465741314e595777676451466444444141524177454741304d45
#EXTINF:11.929,
https://hls.one/TX_32393934417746575541514256414549425151444477454444465657414645465546465558314d564577465741314e595777676451466444444145524177454741304d45
#EXTINF:11.929,
https://hls.one/TX_6334626641774d4d55675a565541774142774654566c6344556c42614146774342674d495646564645676b44445152595756496651674e48414141544167465856786348
#EXTINF:11.595,
https://hls.one/TX_61333237416764534131554b4346705555314e635567594341464d435877645658415255415159584551514556674a5a5851784f45567766566c564842776c5641684656
#EXTINF:11.928,
https://hls.one/TX_65666438415149434177634b425673465551594441514d4555514a565667634f564163464477495252774941426752615746784f51317753567764465567565641555256
#EXTINF:11.303,
https://hls.one/TX_3861623543514e5256516b434346315642674d424451594441316b4f4241384741674d4458675248524651455667525357513859545651665556595355776746426b6458
#EXTINF:10.511,
https://hls.one/TX_33386333426c494256774544424139545667734f4241414944777851426c554d56675a535677635351776743566c566443463861525655544131644343515a5141685949
#EXTINF:11.720,
https://hls.one/TX_33386333426c49425677454442413954566738505677355243676c584251515041564258426c415351776743566c5664434638615256555441315a4343515a5141685949
#EXTINF:11.845,
https://hls.one/TX_3835316541515943423145464141355542414948566745435556705855774943425151444431495552674656416c4e615846784b46564d58416c49514267525641425656
#EXTINF:11.928,
https://hls.one/TX_39613166426c525655564d4442676b4441516b43446751435556594641467341553164534241464445776c5255514e644467736346315552425151564346594956554254
#EXTINF:11.929,
https://hls.one/TX_64646239415139524267514656516c554167454256774948426c56665651465441674e57556c456652414e5755675a615651394c51464e4342567757416c4d4656524654
#EXTINF:11.637,
https://hls.one/TX_66323563564646514146554c5656304a42314e53574163464131414156514d4841674d4d4341635552514d49426763504377354e45563143555141544241465141684258
#EXTINF:11.011,
https://hls.one/TX_66323563564646514146554c5656304a4277554341676347564677425667594256315a5a5541515552514d49426763504377354e4556314355676b544241465141684258
#EXTINF:11.136,
https://hls.one/TX_6138323542464a51556c494355416b4a56414943424646565546734155564d415577414641564d58465163475556646643413466466c5248426768414267414342685655
#EXTINF:11.928,
https://hls.one/TX_61343762423159435667634642567854566c5a5655777858566c5656556c425455777350564646455346565742564e634446776251314d535531464342514e5841455146
#EXTINF:11.512,
https://hls.one/TX_3038306142774d4455564d464267425241463154446c68585546425741467741427742574277735346676853417735635756306346314d52443149554356514a44556343
#EXTINF:11.929,
https://hls.one/TX_336234344246465141674e5156417341566c4147586c494742414e555551494443515a57554664445156494a56564e664377355052775a44424152434251454a41785545
#EXTINF:11.928,
https://hls.one/TX_633530355631454541774d47426c68524141645341414148554173485641414442315a5658564d51514156524251514d4331704f52314152563151555631594642454943
#EXTINF:11.637,
https://hls.one/TX_633530355631454541774d47426c685241414a65556764644156785355414e5641564d4156773051514156524251514d4331704f52314152563163555631594642454943
#EXTINF:11.636,
https://hls.one/TX_61306366427752564151494b42416b4242564a5841414d4543514d47576764564431465656314d574556594342674a635867744d526c775442675952564146545668594a
#EXTINF:11.470,
https://hls.one/TX_6539353143564545555145475641414942674d4641776348424159425531526342414d434231424452565a574441525343316f6352564244447741534177634756686458
#EXTINF:11.011,
https://hls.one/TX_66343138416749484156494143516741415170554167594c43415258556764514156315a5767394346674a544131565a57466c4d466c596542776b564131565655423442
#EXTINF:11.929,
    """

    uel_header_v2 = 'https://ltsyz.gtimg.com/B_z0uFUcqAKH-ura3tu2xWp_3YNnxtQUauOyuCZY0HLTZQP4zg3WPRFxGMUwiCgwgzLIXztKRJm4XdaWI5AVIlvbhnJqGumXJK4RfyDo-zWuEsZJ7k1kGXJJnKFS9SMU0QnC0rVGEZQrwqEhzHTmjBoA/svp_50112/qqKt1CU9qBHTubwJDdT4zAblLGBugfladsGEeRLxU3c_kLUW-YReWHsAF-Ez1ACBjOeI0ityZUfWE-8qecvoNZjqMPfMoHpIgyJbdWokgIwF0j9dkOA4RSWfr3PCnO6Z5snq22XRwsUvot8HVefMh43rJzrLZMFfUiG8HINjfKsf4cXPgss9U5ZTcDxsEY3Y3rasgsowWa43Ux3qDexAIHKiCoeeZaqKdiSP_UG9kXE/'

    ts_convert(m3u8_content, uel_header_v2)
